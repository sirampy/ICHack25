
{% extends "base.html" %}

{% block title %}Reader{% endblock %}

{% block head %}
{% endblock %}

{% block content %}

<button id="connectButton">Connect</button>
<div id="output"></div>

<script>
const connectButton = document.getElementById('connectButton');
const outputDiv = document.getElementById('output');
let port;
let writer;
let reader;

const filters = [
  { usbVendorId: 0x2e8a, usbProductId: 0x000a },
];

connectButton.addEventListener('click', async () => {
    if (!port) {
      try {
        port = await navigator.serial.requestPort({ filters });
        await port.open({ baudRate: 115200 }); // Adjust baudRate if needed

        writer = port.writable.getWriter();
        reader = port.readable.getReader();
        
        outputDiv.innerHTML += '<p>Connected to Serial Port</p>';
        
        sendCharAndReadLine(); // Call the function to send and read
        
      } catch (error) {
         outputDiv.innerHTML += `<p>Error opening port: ${error}</p>`;
      }
    } else {
      outputDiv.innerHTML += '<p>Port is already open.</p>';
    }
});



async function sendCharAndReadLine() {
  try {
    // 1. Send a single character (e.g., 'A')
    const charToSend = 'R';
    const data = new Uint8Array([charToSend.charCodeAt(0)]);
    await writer.write(data);


    let line = '';
    const { value, done } = await reader.read();
    // console.log(value);
    const decoder = new TextDecoder();
    const text = decoder.decode(value);

    console.log(text)

    // SEND

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/upload", true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.send(text); 

      
    
  } catch (error) {
    outputDiv.innerHTML += `<p>Error during communication: ${error}</p>`;
  } finally {
     // release the reader and writer (optional, useful if you plan to send/read more later)
      if (reader) {
          reader.releaseLock();
      }
      if (writer) {
        writer.releaseLock();
      }
  }
}
</script>

{% endblock %}
